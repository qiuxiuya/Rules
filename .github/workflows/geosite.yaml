name: Build

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:
  push:
    paths-ignore:
      - "**/README.md"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Checkout domain-list-community
        uses: actions/checkout@v2
        with:
          repository: v2fly/domain-list-community
          path: domain-list-community

      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: ^1.18

      - name: Generate rules
        run: |
          
          cd ../clash
          go run main.go ../domain-list-community ../release/clash
          wget -q -O ../release/clash/Country.mmdb https://raw.githubusercontent.com/yuumimi/geoip/release/Country.mmdb
          wget -q -O ../release/clash/geoip.dat https://raw.githubusercontent.com/yuumimi/geoip/release/geoip.dat
          wget -q -O ../release/clash/geosite.dat https://raw.githubusercontent.com/yuumimi/geosite/release/geosite.dat

          cd ../loon
          go run main.go ../domain-list-community ../release/loon
          wget -q -O ../release/loon/cn.mmdb https://raw.githubusercontent.com/yuumimi/chnroutes2mmdb/release/chnroutes.mmdb

          cd ../surge
          go run main.go ../domain-list-community ../release/surge
          wget -q -O ../release/surge/cn.mmdb https://raw.githubusercontent.com/yuumimi/chnroutes2mmdb/release/chnroutes.mmdb

          cd ../sing-box
          mkdir -p ../release/sing-box/rule-set
          go run main.go ../domain-list-community ../release/sing-box/rule-set

      - name: Optional post-processing (Clash example)
        run: |
          cd clash-post && bash process-clash.sh

      - name: Get commit message
        id: commit
        uses: actions/github-script@v6
        with:
          result-encoding: string
          script: |
            const msg = context.payload.head_commit?.message;
            return msg || `Generate at ${new Date().toISOString()}`;

      - name: Deploy to geosite branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: geosite
          publish_dir: release
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          full_commit_message: ${{ steps.commit.outputs.result }}
          force_orphan: true
          enable_jekyll: true
          exclude_assets: '.nojekyll'
